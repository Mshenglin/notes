### 索引的常见模型

常见的简单的三种数据模型：哈希表、有序数组和搜索树。

哈希表：是一种以键-值(key-value)储存的数据结构，我们可以通过待查找的的键就可以找到对应的值。当出现哈希冲突，就需要在一个链表来解决哈希冲突。

哈希表的优缺点：适用于等值查询，但是在范围查询中，速度很慢。

有序数组：通过数组来存储数据，在等值和范围查询都很优秀，当我们将一组数据有序的存放在数组中，我们通过二分查找可以在O(log(N))的时间复杂度下快速得到。但是当我们要在数组中插入一个元素的时候，成本非常的高。**所以，有序数组适合静态存储引擎。**

二叉树：通过左右子树，来存储数据。典型的二叉树——二分搜索树。他的特点是每个节点的左子树小于父节点，父节点小于右节点。查询一个元素的时间复杂度是O(log(N))。

### InnoDB的索引模型

在InnoDB中，表都是以主键顺序以索引的形式存放的，这种存储方式的表叫做索引组织表，每个索引在InnoDB中对应一颗B+树。

```sql
mysql> create table T (
ID int primary key,
k int NOT NULL DEFAULT 0, 
s varchar(16) NOT NULL DEFAULT '',
index k(k))
engine=InnoDB;

insert into T values(100,1, 'aa'),(200,2,'bb'),(300,3,'cc'),(500,5,'ee'),(600,6,'ff'),(700,7,'gg');
```

根据叶子节点的内容。索引内容分为主键索引和非主键索引。

**主键索引的叶子节点存的是整行数据。**在InnoDB中主键索引也称为聚簇索引。

**非主键索引叶子节点内容是主键的值**。在InnoDB中非主键索引被称为二级索引。

基于主键索引和普通索引的查询有什么区别？

- 如果语句是通过主键来查询，则只需要搜索主键这一棵B+树。
- 如果语句是普通索引查询，则需要先搜索普通索引树，然后得到主键，在主键索引树再查找一遍这个过程被称为回表。
- 如果语句是select * from T where ID=500，即主键查询方式，则只需要搜索ID这棵B+树；
- 如果语句是select * from T where k=5，即普通索引查询方式，则需要先搜索k索引树，得到ID的值为500，再到ID索引树搜索一次。这个过程称为回表。

### 索引维护

B+为了维护索引的有序性，在插入新值的时候需要做必要的维护，当出现数据页满的情况下，根据B+树的算法，就会申请一个新的页然后挪动部分数据过去。这个过程称为页分裂。页分裂操作会影响数据页的利用率，以及性能。有页的分裂，就会有合并，是与页分裂相似。

### 覆盖索引

如果我们再上面的那个表中执行的语句是

```sql
select ID from T where k between 3 and 5
```

再这里我们我们只需要查询ID的值，而ID的值已经再k索引树上有了可以直接提供查询结果，不需要回表，在这个查询的过程中，索引k覆盖了我们的查询，所以我们称为覆盖索引。

**由于覆盖索引可以减少树的搜索次数，显著的提升查询性能，所以使用覆盖索引是常用的性能优化手段。**

### 最左前缀原则

当我们使用联合索引的时候，B+树这种索引结构，利用索引的最左前缀，来定位纪录。

所谓最左前缀原则，就是我们使用两列或两列以上的字段做索引。在使用该索引查找数据的时候，是使用从左到右的字段依次查找，所以，我们在建立联合索引的时候，**如何安排索引内的字段内容**。**通过调整顺序，可以少维护一个索引，那么这个顺序是需要优先考虑的。**、

### 索引下推

上面我们在满足最左前缀原则的时候，可以用于索引中定位记录，当我们定位到我们需要的内容，但是后面的内容不满足最左前缀原则时，该如何呢？

```sql
CREATE TABLE `tuser` (
  `id` int(11) NOT NULL,
  `id_card` varchar(32) DEFAULT NULL,
  `name` varchar(32) DEFAULT NULL,
  `age` int(11) DEFAULT NULL,
  `ismale` tinyint(1) DEFAULT NULL,
  PRIMARY KEY (`id`),
  KEY `id_card` (`id_card`),
  KEY `name_age` (`name`,`age`)
) ENGINE=InnoDB
```

上面这个表是一个使居民表当我们执行下面这条sql时，

```sql
mysql> select * from tuser where name like '张%' and age=10 and ismale=1
```

查找表中名字带张，通过联合索引(name,age)查找到名字带张的数据。

在MySQL5.6之前，只能在查找出来的内容一个一个的回表在主键索引上找到数据行。

在MySQL5.6引入索引下推优化，在索引遍历的过程中，对索引中包含的字段先判断，过滤掉不满足的记录，减少回表次数。